<!DOCTYPE html>
<html lang="bn">
<head>
<meta name="monetag" content="3d39a80ceaf0eb06704eb848f800bbe4">
    <meta charset="UTF-8">
    <meta name="monetag" content="3d39a80ceaf0eb06704eb848f800bbe4">
    <title>Task Earn Pro - ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ü‡¶∞‡ßç‡¶® ‡¶™‡ßç‡¶∞‡ßã</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: ltr;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
        }

        .balance-card {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .ads-button {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px;
            width: calc(100% - 40px);
            box-shadow: 0 4px 15px rgba(156,39,176,0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ads-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156,39,176,0.4);
        }

        .ads-button:active {
            transform: translateY(0);
        }

        .ads-button::before {
            content: 'üì∫';
            margin-right: 10px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 0 20px 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            margin: 0 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .task-card {
            background: white;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #FF6B6B;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: bold;
            font-size: 16px;
        }

        .task-reward {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .task-button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .task-button:hover {
            background: #45a049;
        }

        .task-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .task-button.completed {
            background: #28a745;
        }

        .monetag-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .monetag-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .monetag-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .monetag-ad-container {
            min-height: 250px;
            background: #f5f5f5;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #9C27B0;
        }

        .monetag-timer {
            font-size: 18px;
            font-weight: bold;
            color: #9C27B0;
            margin: 15px 0;
        }

        .monetag-reward {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 15px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .referral-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .referral-link {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 12px;
        }

        .copy-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .referral-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .withdrawal-request {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #FF6B6B;
        }

        .status-pending {
            color: #FF6B6B;
            font-weight: bold;
        }

        .status-approved {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-rejected {
            color: #f44336;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        .blocked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .blocked-message {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .balance-update {
            animation: balanceUpdate 0.5s ease-in-out;
        }

        @keyframes balanceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #4CAF50; }
            100% { transform: scale(1); }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                font-size: 12px;
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">üîÑ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    
    <!-- Blocked User Overlay -->
    <div class="blocked-overlay" id="blockedOverlay">
        <div class="blocked-message">
            <h3>üö´ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï</h3>
            <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>
    </div>

    <!-- Monetag Ad Modal -->
    <div class="monetag-modal" id="monetagModal">
        <div class="monetag-content">
            <button class="monetag-close" onclick="closeMonetagModal()">&times;</button>
            <h3>üì∫ Monetag ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®</h3>
            <div class="monetag-ad-container" id="monetagAdContainer">
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∫</div>
                    <div>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
                </div>
            </div>
            <div class="monetag-timer" id="monetagTimer">‚è±Ô∏è ‡ß¶‡ß¶:‡ß©‡ß¶</div>
            <div class="monetag-reward">üéÅ +2 ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶¨‡ßá‡¶®!</div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶®
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üéØ Task Earn Pro</h1>
            <div class="subtitle">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®, ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            <div class="user-info" id="userInfo">
                <div>üë§ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-amount" id="userBalance">‡ß≥‡ß¶</div>
            <div class="balance-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
        </div>

        <button class="ads-button pulse" onclick="showMonetagAd()">
            ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">‡ß¶</div>
                <div class="stat-label">‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="referralCount">‡ß¶</div>
                <div class="stat-label">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('tasks')">üìã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</button>
            <button class="nav-tab" onclick="showTab('referral')">üë• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞</button>
            <button class="nav-tab" onclick="showTab('withdraw')">üí∞ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</button>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content active">
            <div id="tasksList" class="loading">
                ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
        </div>

        <!-- Referral Tab -->
        <div id="referral" class="tab-content">
            <div class="referral-card">
                <h3>üë• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</h3>
                <p>‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ú‡¶æ‡¶®‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø <span id="referralBonus">‡ßß‡ß¶</span> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶®!</p>
                <div class="referral-link" id="daily_income_bd_earning_bot">
                    ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                </div>
                <button class="copy-btn" onclick="copyReferralLink()">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h4>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h4>
                <div id="referralList" class="loading">
                    ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                </div>
            </div>
        </div>

        <!-- Withdraw Tab -->
        <div id="withdraw" class="tab-content">
            <div class="form-group">
                <label class="form-label">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</label>
                <select class="form-select" id="paymentMethod">
                    <option value="bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                    <option value="nagad">‡¶®‡¶ó‡¶¶</option>
                    <option value="rocket">‡¶∞‡¶ï‡ßá‡¶ü</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                <input type="tel" class="form-input" id="phoneNumber" placeholder="01XXXXXXXXX">
            </div>

            <div class="form-group">
                <label class="form-label">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® <span id="minWithdrawAmount">‡ßß‡ß¶‡ß¶</span> ‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                <input type="number" class="form-input" id="withdrawAmount" placeholder="‡ßß‡ß¶‡ß¶" min="100">
            </div>

            <button class="submit-btn" onclick="requestWithdrawal()">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>

            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 30px;">
                <h4>‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø</h4>
                <div id="withdrawHistory" class="loading">
                    ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyBrmybI-BLU7mYmKixvKrop-0cFEWfYHjA",
            authDomain: "earn-money-fed60.firebaseapp.com",
            databaseURL: "https://earn-money-fed60-default-rtdb.firebaseio.com",
            projectId: "earn-money-fed60",
            storageBucket: "earn-money-fed60.firebasestorage.app",
            messagingSenderId: "1068823227874",
            appId: "1:1068823227874:web:d6760e3b4bfa8670aa9dbb"
        };

        // Initialize Firebase
        let database;
        let isConnected = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // Monitor connection status
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                isConnected = snapshot.val();
                updateConnectionStatus();
            });
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showMessage('Firebase ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶°‡ßá‡¶Æ‡ßã ‡¶Æ‡ßã‡¶°‡ßá ‡¶ö‡¶≤‡¶õ‡ßá‡•§', 'error');
        }

        // Global Variables
        let currentUser = null;
        let allTasks = [];
        let userReferrals = [];
        let withdrawRequests = [];
        let appSettings = {
            referralBonus: 100,
            minWithdraw: 100,
            adReward: 50
        };
        let monetagTimer = null;
        let adWatchTime = 30;

        // Telegram WebApp Integration
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        }

        // Initialize App
        async function initApp() {
            try {
                await authenticateUser();
                await loadAppSettings();
                await loadUserData();
                await loadTasks();
                await loadReferrals();
                await loadWithdrawHistory();
                setupRealtimeListeners();
                processReferralIfExists();
            } catch (error) {
                console.error('App initialization error:', error);
                showMessage('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            }
        }

        // User Authentication using Telegram WebApp SDK
        async function authenticateUser() {
            let userId, name, username;

            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                // Real Telegram data
                const user = tg.initDataUnsafe.user;
                userId = user.id.toString();
                name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                username = user.username || '';
            } else {
                // Demo data for testing
                userId = 'demo_' + Math.random().toString(36).substr(2, 9);
                name = '‡¶°‡ßá‡¶Æ‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞';
                username = 'demo_user';
            }

            // User profile structure as specified: { name, username, balance, refs, tasksCompleted, isBlocked }
            currentUser = {
                id: userId,
                name: name,
                username: username,
                balance: 0,
                refs: {},
                tasksCompleted: {},
                isBlocked: false
            };

            // Update user info in UI
            document.getElementById('userInfo').innerHTML = `
                <div>üë§ ${name}</div>
                <div style="font-size: 10px; opacity: 0.8;">@${username} (ID: ${userId})</div>
            `;

            // Store/update user profile under /users/{userId}
            if (database) {
                const userRef = database.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    // Create new user with exact structure
                    await userRef.set({
                        name: name,
                        username: username,
                        balance: 0,
                        refs: {},
                        tasksCompleted: {},
                        isBlocked: false,
                        joinDate: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Update existing user info
                    await userRef.update({
                        name: name,
                        username: username,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }
        }

        // Load App Settings
        async function loadAppSettings() {
            if (!database) return;

            try {
                const settingsRef = database.ref('settings');
                const snapshot = await settingsRef.once('value');
                
                if (snapshot.exists()) {
                    appSettings = { ...appSettings, ...snapshot.val() };
                }
                
                // Update UI with settings
                document.getElementById('referralBonus').textContent = appSettings.referralBonus || 100;
                document.getElementById('minWithdrawAmount').textContent = appSettings.minWithdraw || 100;
                document.getElementById('withdrawAmount').min = appSettings.minWithdraw || 100;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load User Data
        async function loadUserData() {
            if (!database || !currentUser) return;

            try {
                const userRef = database.ref('users/' + currentUser.id);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentUser = { ...currentUser, ...userData };
                    
                    // Check if user is blocked
                    if (currentUser.isBlocked) {
                        document.getElementById('blockedOverlay').style.display = 'flex';
                        return;
                    }
                    
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load Tasks from Firebase (/tasks/)
        async function loadTasks() {
            if (!database) {
                // Demo tasks
                allTasks = [
                    {
                        id: 'youtube_1',
                        type: 'youtube',
                        title: '‡¶á‡¶â‡¶ü‡¶ø‡¶â‡¶¨ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®',
                        description: '‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶®',
                        reward: 50,
                        url: 'https://youtube.com/watch?v=demo',
                        duration: 60,
                        active: true
                    },
                    {
                        id: 'telegram_1',
                        type: 'telegram',
                        title: '‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ú‡¶Ø‡¶º‡ßá‡¶®',
                        description: '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                        reward: 30,
                        url: 'https://t.me/TaskEarnChannel',
                        active: true
                    },
                    {
                        id: 'website_1',
                        type: 'website',
                        title: '‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                        description: '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶®‡¶æ‡¶∞ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                        reward: 25,
                        url: 'https://example.com',
                        active: true
                    }
                ];
                renderTasks();
                return;
            }

            try {
                const tasksRef = database.ref('tasks');
                const snapshot = await tasksRef.once('value');
                
                if (snapshot.exists()) {
                    const tasksData = snapshot.val();
                    allTasks = Object.keys(tasksData).map(key => ({
                        id: key,
                        ...tasksData[key]
                    })).filter(task => task.active);
                } else {
                    allTasks = [];
                }
                
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksList').innerHTML = '<div style="text-align: center; color: #f44336;">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
            }
        }

        // Render Tasks
        function renderTasks() {
            const tasksContainer = document.getElementById('tasksList');
            
            if (allTasks.length === 0) {
                tasksContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>';
                return;
            }

            tasksContainer.innerHTML = allTasks.map(task => {
                const isCompleted = currentUser.tasksCompleted && currentUser.tasksCompleted[task.id];
                
                return `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-title">${getTaskIcon(task.type)} ${task.title}</div>
                            <div class="task-reward">+‡ß≥${task.reward}</div>
                        </div>
                        <div class="task-description">${task.description}</div>
                        <button class="task-button ${isCompleted ? 'completed' : ''}" 
                                onclick="completeTask('${task.id}')" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‚úì' : '‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Get Task Icon
        function getTaskIcon(type) {
            const icons = {
                youtube: 'üé•',
                telegram: 'üì¢',
                website: 'üåê',
                app: 'üì±',
                survey: 'üìä'
            };
            return icons[type] || 'üìã';
        }

        // Complete Task - Update /users/{id}/balance and /users/{id}/tasksCompleted
        async function completeTask(taskId) {
            if (!currentUser || (currentUser.tasksCompleted && currentUser.tasksCompleted[taskId])) {
                return;
            }

            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            const button = event.target;
            button.disabled = true;
            button.textContent = '‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£...';

            try {
                // Open task URL
                if (task.url) {
                    window.open(task.url, '_blank');
                }

                // Simulate task completion delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                if (database) {
                    // Update /users/{id}/balance and add task to /users/{id}/tasksCompleted
                    const updates = {};
                    updates[`users/${currentUser.id}/balance`] = firebase.database.ServerValue.increment(task.reward);
                    updates[`users/${currentUser.id}/tasksCompleted/${taskId}`] = {
                        completedAt: firebase.database.ServerValue.TIMESTAMP,
                        reward: task.reward
                    };

                    await database.ref().update(updates);
                } else {
                    // Demo mode
                    currentUser.balance = (currentUser.balance || 0) + task.reward;
                    if (!currentUser.tasksCompleted) currentUser.tasksCompleted = {};
                    currentUser.tasksCompleted[taskId] = {
                        completedAt: Date.now(),
                        reward: task.reward
                    };
                    updateUI();
                }

                button.textContent = '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‚úì';
                button.classList.add('completed');
                showMessage(`‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${task.reward} ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§`, 'success');

            } catch (error) {
                console.error('Error completing task:', error);
                button.disabled = false;
                button.textContent = '‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®';
                showMessage('‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            }
        }

        // Show Monetag Ad Modal
        function showMonetagAd() {
            const modal = document.getElementById('monetagModal');
            modal.style.display = 'flex';
            
            // Reset timer
            adWatchTime = 30;
            updateMonetagTimer();
            
            // Simulate ad loading
            setTimeout(() => {
                loadMonetagAdContent();
                startMonetagTimer();
            }, 1000);
        }

        // Load Monetag Ad Content
        function loadMonetagAdContent() {
            const adContainer = document.getElementById('monetagAdContainer');
            
            // Simulate Monetag ad content
            adContainer.innerHTML = `
                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #9C27B0, #E91E63); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">üéØ</div>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">Monetag Advertisement</div>
                    <div style="font-size: 12px; opacity: 0.8;">Sample Ad Content</div>
                    <div style="margin-top: 15px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 15px; font-size: 12px;">
                        Click to Learn More
                    </div>
                </div>
            `;
        }

        // Start Monetag Timer
        function startMonetagTimer() {
            monetagTimer = setInterval(() => {
                adWatchTime--;
                updateMonetagTimer();
                
                if (adWatchTime <= 0) {
                    clearInterval(monetagTimer);
                    completeMonetagAd();
                }
            }, 1000);
        }

        // Update Monetag Timer Display
        function updateMonetagTimer() {
            const timerElement = document.getElementById('monetagTimer');
            const minutes = Math.floor(adWatchTime / 60);
            const seconds = adWatchTime % 60;
            timerElement.textContent = `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Complete Monetag Ad - Update /users/{id}/balance with earned points
        async function completeMonetagAd() {
            if (!currentUser) return;

            try {
                const adReward = appSettings.adReward || 50;

                if (database) {
                    // Update /users/{id}/balance with Firebase Realtime listeners for real-time balance update
                    await database.ref(`users/${currentUser.id}/balance`).transaction((currentBalance) => {
                        return (currentBalance || 0) + adReward;
                    });
                } else {
                    // Demo mode
                    currentUser.balance = (currentUser.balance || 0) + adReward;
                    updateUI();
                }

                // Show success message
                showMessage(`üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${adReward} ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!`, 'success');
                
                // Close modal after a delay
                setTimeout(() => {
                    closeMonetagModal();
                }, 2000);

            } catch (error) {
                console.error('Error completing Monetag ad:', error);
                showMessage('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            }
        }

        // Close Monetag Modal
        function closeMonetagModal() {
            const modal = document.getElementById('monetagModal');
            modal.style.display = 'none';
            
            if (monetagTimer) {
                clearInterval(monetagTimer);
                monetagTimer = null;
            }
        }

        // Process Referral from URL
        function processReferralIfExists() {
            if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.start_param) return;

            const startParam = tg.initDataUnsafe.start_param;
            if (startParam.startsWith('ref_')) {
                const referrerId = startParam.replace('ref_', '');
                if (referrerId !== currentUser.id) {
                    processReferral(referrerId);
                }
            }
        }

        // Process Referral - Store referrals in /users/{id}/refs, bonus points directly update /users/{id}/balance
        async function processReferral(referrerId) {
            if (!database || !currentUser) return;

            try {
                // Check if user is already referred
                const userRef = database.ref(`users/${currentUser.id}`);
                const userSnapshot = await userRef.once('value');
                
                if (userSnapshot.exists() && userSnapshot.val().referredBy) {
                    return; // Already referred
                }

                // Check if referrer exists
                const referrerRef = database.ref(`users/${referrerId}`);
                const referrerSnapshot = await referrerRef.once('value');
                
                if (!referrerSnapshot.exists()) return;

                const referrerData = referrerSnapshot.val();
                const referralBonus = appSettings.referralBonus || 100;

                // Store referrals in /users/{id}/refs and bonus points directly update /users/{id}/balance
                const updates = {};
                updates[`users/${referrerId}/refs/${currentUser.id}`] = {
                    name: currentUser.name,
                    username: currentUser.username,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    bonus: referralBonus
                };
                updates[`users/${referrerId}/balance`] = firebase.database.ServerValue.increment(referralBonus);
                updates[`users/${currentUser.id}/referredBy`] = referrerId;

                await database.ref().update(updates);

                showMessage(`‡¶Ü‡¶™‡¶®‡¶ø ${referrerData.name} ‡¶è‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®!`, 'success');
            } catch (error) {
                console.error('Error processing referral:', error);
            }
        }

        // Load Referrals from /users/{id}/refs
        async function loadReferrals() {
            if (!database || !currentUser) {
                document.getElementById('referralList').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶®‡ßá‡¶á</div>';
                return;
            }

            try {
                const userRef = database.ref('users/' + currentUser.id + '/refs');
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const refsData = snapshot.val();
                    userReferrals = Object.keys(refsData).map(key => ({
                        id: key,
                        ...refsData[key]
                    }));
                } else {
                    userReferrals = [];
                }
                
                renderReferrals();
            } catch (error) {
                console.error('Error loading referrals:', error);
                document.getElementById('referralList').innerHTML = '<div style="text-align: center; color: #f44336;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
            }
        }

        // Render Referrals
        function renderReferrals() {
            const referralContainer = document.getElementById('referralList');
            
            if (userReferrals.length === 0) {
                referralContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶®‡ßá‡¶á</div>';
                return;
            }

            referralContainer.innerHTML = userReferrals.map(ref => `
                <div class="referral-item">
                    <div>
                        <strong>${ref.name || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'}</strong><br>
                        <small>‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®: ${new Date(ref.joinedAt).toLocaleDateString('bn-BD')}</small>
                    </div>
                    <div style="color: #4CAF50; font-weight: bold;">+‡ß≥${ref.bonus || appSettings.referralBonus}</div>
                </div>
            `).join('');
        }

        // Generate and Copy Referral Link
        function copyReferralLink() {
            if (!currentUser) return;
            
            const referralLink = `https://t.me/TaskEarnBot?start=ref_${currentUser.id}`;
            document.getElementById('referralLink').textContent = referralLink;
            
            navigator.clipboard.writeText(referralLink).then(() => {
                showMessage('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
            }).catch(() => {
                showMessage('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            });
        }

        // Request Withdrawal - Create /withdraw_requests/{requestId} with: { userId, method, number, amount, status:'pending' }
        async function requestWithdrawal() {
            if (!currentUser) return;

            const method = document.getElementById('paymentMethod').value;
            const number = document.getElementById('phoneNumber').value;
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const minWithdraw = appSettings.minWithdraw || 100;

            if (!number || !amount || amount < minWithdraw) {
                showMessage(`‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ${minWithdraw} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§`, 'error');
                return;
            }

            if (amount > (currentUser.balance || 0)) {
                showMessage('‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡•§', 'error');
                return;
            }

            try {
                const requestId = 'wd_' + Date.now() + '_' + currentUser.id;
                
                // Withdraw request structure as specified: { userId, method, number, amount, status:'pending' }
                const withdrawRequest = {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    method: method,
                    number: number,
                    amount: amount,
                    status: 'pending',
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };

                if (database) {
                    // Create /withdraw_requests/{requestId} and deduct balance
                    const updates = {};
                    updates[`withdraw_requests/${requestId}`] = withdrawRequest;
                    updates[`users/${currentUser.id}/balance`] = firebase.database.ServerValue.increment(-amount);

                    await database.ref().update(updates);
                } else {
                    // Demo mode
                    currentUser.balance = (currentUser.balance || 0) - amount;
                    updateUI();
                }

                // Clear form
                document.getElementById('phoneNumber').value = '';
                document.getElementById('withdrawAmount').value = '';

                showMessage('‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'success');
                loadWithdrawHistory();

            } catch (error) {
                console.error('Error requesting withdrawal:', error);
                showMessage('‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            }
        }

        // Load Withdraw History
        async function loadWithdrawHistory() {
            if (!database || !currentUser) {
                document.getElementById('withdrawHistory').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>';
                return;
            }

            try {
                const withdrawRef = database.ref('withdraw_requests').orderByChild('userId').equalTo(currentUser.id);
                const snapshot = await withdrawRef.once('value');
                
                if (snapshot.exists()) {
                    const withdrawData = snapshot.val();
                    withdrawRequests = Object.keys(withdrawData).map(key => ({
                        id: key,
                        ...withdrawData[key]
                    })).sort((a, b) => b.requestedAt - a.requestedAt);
                } else {
                    withdrawRequests = [];
                }
                
                renderWithdrawHistory();
            } catch (error) {
                console.error('Error loading withdraw history:', error);
                document.getElementById('withdrawHistory').innerHTML = '<div style="text-align: center; color: #f44336;">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
            }
        }

        // Render Withdraw History
        function renderWithdrawHistory() {
            const historyContainer = document.getElementById('withdrawHistory');
            
            if (withdrawRequests.length === 0) {
                historyContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>';
                return;
            }

            historyContainer.innerHTML = withdrawRequests.map(req => `
                <div class="withdrawal-request">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${req.method.toUpperCase()}: ${req.number}</strong><br>
                            <small>‡ß≥${req.amount} - ${new Date(req.requestedAt).toLocaleDateString('bn-BD')}</small>
                        </div>
                        <div class="status-${req.status}">${getStatusText(req.status)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Get Status Text
        function getStatusText(status) {
            const statusMap = {
                'pending': '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶£',
                'approved': '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',
                'rejected': '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶§'
            };
            return statusMap[status] || status;
        }

        // Setup Realtime Listeners - Balance, tasks, referrals auto-update via Firebase listeners
        function setupRealtimeListeners() {
            if (!database || !currentUser) return;

            // Listen to user data changes (balance, tasks, referrals auto-update)
            const userRef = database.ref('users/' + currentUser.id);
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const oldBalance = currentUser.balance || 0;
                    currentUser = { ...currentUser, ...userData };
                    
                    // Check if user got blocked
                    if (currentUser.isBlocked) {
                        document.getElementById('blockedOverlay').style.display = 'flex';
                        return;
                    } else {
                        document.getElementById('blockedOverlay').style.display = 'none';
                    }
                    
                    // Animate balance update if changed
                    if ((currentUser.balance || 0) !== oldBalance) {
                        const balanceElement = document.getElementById('userBalance');
                        balanceElement.classList.add('balance-update');
                        setTimeout(() => {
                            balanceElement.classList.remove('balance-update');
                        }, 500);
                    }
                    
                    updateUI();
                }
            });

            // Listen to tasks changes
            const tasksRef = database.ref('tasks');
            tasksRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const tasksData = snapshot.val();
                    allTasks = Object.keys(tasksData).map(key => ({
                        id: key,
                        ...tasksData[key]
                    })).filter(task => task.active);
                    renderTasks();
                }
            });

            // Listen to referrals changes
            const refsRef = database.ref('users/' + currentUser.id + '/refs');
            refsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const refsData = snapshot.val();
                    userReferrals = Object.keys(refsData).map(key => ({
                        id: key,
                        ...refsData[key]
                    }));
                } else {
                    userReferrals = [];
                }
                renderReferrals();
            });

            // Listen to withdraw requests changes
            const withdrawRef = database.ref('withdraw_requests').orderByChild('userId').equalTo(currentUser.id);
            withdrawRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const withdrawData = snapshot.val();
                    withdrawRequests = Object.keys(withdrawData).map(key => ({
                        id: key,
                        ...withdrawData[key]
                    })).sort((a, b) => b.requestedAt - a.requestedAt);
                } else {
                    withdrawRequests = [];
                }
                renderWithdrawHistory();
            });

            // Listen to settings changes
            const settingsRef = database.ref('settings');
            settingsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    appSettings = { ...appSettings, ...snapshot.val() };
                    document.getElementById('referralBonus').textContent = appSettings.referralBonus || 100;
                    document.getElementById('minWithdrawAmount').textContent = appSettings.minWithdraw || 100;
                    document.getElementById('withdrawAmount').min = appSettings.minWithdraw || 100;
                }
            });
        }

        // Update UI
        function updateUI() {
            if (!currentUser) return;

            document.getElementById('userBalance').textContent = '‡ß≥' + (currentUser.balance || 0);
            
            const completedCount = currentUser.tasksCompleted ? Object.keys(currentUser.tasksCompleted).length : 0;
            document.getElementById('completedTasks').textContent = completedCount;
            
            const referralCount = currentUser.refs ? Object.keys(currentUser.refs).length : 0;
            document.getElementById('referralCount').textContent = referralCount;

            // Generate referral link
            if (currentUser.id) {
                const referralLink = `https://t.me/TaskEarnBot?start=ref_${currentUser.id}`;
                document.getElementById('referralLink').textContent = referralLink;
            }
        }

        // Update Connection Status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = 'üü¢ ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'üî¥ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®';
                statusElement.className = 'connection-status disconnected';
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Show Message
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            document.querySelector('.container').appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Handle page visibility change to reconnect if needed
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && database) {
                // Refresh data when page becomes visible
                loadUserData();
                loadTasks();
                loadReferrals();
                loadWithdrawHistory();
            }
        });

        // Close modal when clicking outside
        document.getElementById('monetagModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('monetagModal')) {
                closeMonetagModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97732c5f52a94ea6',t:'MTc1NjU0NTIxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>



